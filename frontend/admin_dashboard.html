<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlapPy Bird 管理控制台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/admin.css" rel="stylesheet">
</head>
<body>
    <!-- 侧边导航栏 -->
    <nav class="admin-sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-gamepad"></i> 管理控制台</h2>
            <p>FlapPy Bird</p>
        </div>
        <div class="sidebar-nav">
            <a href="/admin_dashboard.html" class="nav-item active">
                <i class="fas fa-tachometer-alt"></i> 系统概览
            </a>
            <a href="/admin_users.html" class="nav-item">
                <i class="fas fa-users"></i> 用户管理
            </a>
            <a href="/admin_frontend.html" class="nav-item">
                <i class="fas fa-palette"></i> 前端管理
            </a>
            <a href="/admin_admins.html" class="nav-item">
                <i class="fas fa-user-shield"></i> 管理员管理
            </a>
            <a href="/admin_system.html" class="nav-item">
                <i class="fas fa-cogs"></i> 系统设置
            </a>
            <a href="/admin_logs.html" class="nav-item">
                <i class="fas fa-file-alt"></i> 系统日志
            </a>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="admin-main">
        <!-- 顶部栏 -->
        <header class="admin-header">
            <div class="header-left">
                <button class="toggle-sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="header-title">系统概览</h1>
            </div>
            <div class="header-right">
                <div class="admin-user">
                    <i class="fas fa-user-shield"></i>
                    <span>加载中...</span>
                </div>
                <button class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </header>

        <!-- 统计卡片 -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <i class="fas fa-spinner fa-spin stat-icon" style="color: #3b82f6;"></i>
                <div class="stat-number">...</div>
                <div class="stat-label">加载统计数据中</div>
            </div>
        </div>

        <!-- 系统管理 -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-tools"></i> 系统管理
                </h2>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-users"></i> 用户管理
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="/admin_users.html" class="btn btn-primary btn-sm">
                            <i class="fas fa-list"></i> 用户列表
                        </a>
                        <button class="btn btn-success btn-sm" onclick="showCreateUserModal()">
                            <i class="fas fa-user-plus"></i> 添加用户
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportUsers()">
                            <i class="fas fa-download"></i> 导出数据
                        </button>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-palette"></i> 前端管理
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="/admin_frontend.html" class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i> 页面管理
                        </a>
                        <button class="btn btn-info btn-sm" onclick="previewSite()">
                            <i class="fas fa-external-link-alt"></i> 预览网站
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="clearCache()">
                            <i class="fas fa-broom"></i> 清理缓存
                        </button>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-chart-line"></i> 数据统计
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-info btn-sm" onclick="viewAnalytics()">
                            <i class="fas fa-analytics"></i> 访问统计
                        </button>
                        <button class="btn btn-success btn-sm" onclick="viewGameStats()">
                            <i class="fas fa-gamepad"></i> 游戏数据
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="generateReport()">
                            <i class="fas fa-file-export"></i> 生成报告
                        </button>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-shield-alt"></i> 系统维护
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-secondary btn-sm" onclick="checkSystemHealth()">
                            <i class="fas fa-heartbeat"></i> 系统检查
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="cleanupData()">
                            <i class="fas fa-trash-alt"></i> 数据清理
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="restartServer()">
                            <i class="fas fa-redo"></i> 重启服务
                        </button>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">
                        <i class="fas fa-user-shield"></i> 管理员管理
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="/admin_admins.html" class="btn btn-primary btn-sm">
                            <i class="fas fa-list"></i> 管理员列表
                        </a>
                        <button class="btn btn-success btn-sm" onclick="addNewAdmin()">
                            <i class="fas fa-user-plus"></i> 添加管理员
                        </button>
                        <button class="btn btn-info btn-sm" onclick="viewAdminLogs()">
                            <i class="fas fa-history"></i> 登录记录
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速访问 -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-link"></i> 快速访问
                </h2>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <a href="/" class="btn btn-secondary" target="_blank">
                    <i class="fas fa-home"></i> 网站首页
                </a>
                <a href="/game.html" class="btn btn-success" target="_blank">
                    <i class="fas fa-gamepad"></i> 开始游戏
                </a>
                <a href="/register.html" class="btn btn-info" target="_blank">
                    <i class="fas fa-user-plus"></i> 用户注册
                </a>
                <a href="/login.html" class="btn btn-primary" target="_blank">
                    <i class="fas fa-sign-in-alt"></i> 用户登录
                </a>
                <a href="/test_download.html" class="btn btn-warning" target="_blank">
                    <i class="fas fa-download"></i> 下载中心
                </a>
                <a href="/health" class="btn btn-secondary" target="_blank">
                    <i class="fas fa-heartbeat"></i> 系统状态
                </a>
            </div>
        </div>

        <!-- 系统日志 -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-terminal"></i> 最近活动
                </h2>
                <button class="btn btn-sm btn-secondary" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
            </div>
            
            <div id="recentLogs" style="background: #1a1a1a; color: #00ff00; padding: 20px; border-radius: 10px; font-family: 'Courier New', monospace; height: 300px; overflow-y: auto;">
                <div style="color: #666;">正在加载系统日志...</div>
            </div>
        </div>
    </main>

    <!-- 创建用户模态框 -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">创建新用户</h3>
                <button class="modal-close" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <form data-api="/api/admin/users/create" data-method="POST">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" name="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">手机号</label>
                    <input type="tel" name="phone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">邮箱</label>
                    <input type="email" name="email" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">初始密码</label>
                    <input type="password" name="password" class="form-input" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createUserModal')">取消</button>
                    <button type="submit" class="btn btn-success">创建用户</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/admin.js"></script>
    <script>
        // 页面特定功能
        let dashboardData = {};

        // 加载仪表板数据
        async function loadDashboard() {
            try {
                const [statsResponse, logsResponse] = await Promise.all([
                    apiCall('/api/admin/stats'),
                    apiCall('/api/admin/logs/recent')
                ]);

                dashboardData = statsResponse;
                updateStatsGrid(statsResponse);
                updateLogs(logsResponse.logs || []);

            } catch (error) {
                showAlert('加载数据失败: ' + error.message, 'error');
                console.error('Dashboard loading error:', error);
            }
        }

        // 更新统计卡片
        function updateStatsGrid(stats) {
            const grid = document.getElementById('statsGrid');
            grid.innerHTML = `
                <div class="stat-card">
                    <i class="fas fa-users stat-icon" style="color: #3b82f6;"></i>
                    <div class="stat-number">${formatNumber(stats.users?.total || 0)}</div>
                    <div class="stat-label">注册用户</div>
                    <div class="stat-detail">活跃: ${formatNumber(stats.users?.active || 0)}</div>
                </div>
                
                <div class="stat-card">
                    <i class="fas fa-download stat-icon" style="color: #10b981;"></i>
                    <div class="stat-number">${formatNumber(stats.downloads?.total || 0)}</div>
                    <div class="stat-label">总下载量</div>
                    <div class="stat-detail">今日: ${formatNumber(stats.downloads?.today || 0)}</div>
                </div>
                
                <div class="stat-card">
                    <i class="fas fa-gamepad stat-icon" style="color: #8b5cf6;"></i>
                    <div class="stat-number">${formatNumber(stats.games?.total || 0)}</div>
                    <div class="stat-label">游戏记录</div>
                    <div class="stat-detail">最高分: ${formatNumber(stats.games?.best_score || 0)}</div>
                </div>
                
                <div class="stat-card">
                    <i class="fas fa-server stat-icon" style="color: #f59e0b;"></i>
                    <div class="stat-number">${stats.system?.uptime || '0h'}</div>
                    <div class="stat-label">运行时间</div>
                    <div class="stat-detail">状态: ${stats.system?.status || '正常'}</div>
                </div>
            `;
        }

        // 更新日志显示
        function updateLogs(logs) {
            const logsEl = document.getElementById('recentLogs');
            if (!logs || logs.length === 0) {
                logsEl.innerHTML = '<div style="color: #666;">暂无系统日志</div>';
                return;
            }

            const logsHTML = logs.map(log => {
                const time = formatDate(log.timestamp, 'HH:mm:ss');
                const level = log.level || 'INFO';
                const color = {
                    'ERROR': '#ff4444',
                    'WARN': '#ffaa00',
                    'INFO': '#00ff00',
                    'DEBUG': '#0088ff'
                }[level] || '#00ff00';

                return `<div style="margin: 5px 0;">
                    [${time}] <span style="color: ${color};">${level}</span> ${log.message}
                </div>`;
            }).join('');

            logsEl.innerHTML = logsHTML;
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        // 刷新仪表板
        async function refreshDashboard() {
            const btn = event.target;
            const icon = btn.querySelector('i');
            icon.className = 'fas fa-spinner fa-spin';
            
            await loadDashboard();
            
            icon.className = 'fas fa-sync-alt';
            showAlert('数据已刷新', 'success', 2000);
        }

        // 显示创建用户模态框
        function showCreateUserModal() {
            showModal('createUserModal');
        }

        // 导出用户数据
        async function exportUsers() {
            try {
                const response = await apiCall('/api/admin/users/export?format=csv');
                
                // 创建下载链接
                const blob = new Blob([response.data], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showAlert('用户数据导出成功', 'success');
            } catch (error) {
                showAlert('导出失败: ' + error.message, 'error');
            }
        }

        // 预览网站
        function previewSite() {
            window.open('/', '_blank');
        }

        // 清理缓存
        async function clearCache() {
            try {
                await apiCall('/api/admin/cache/clear', 'POST');
                showAlert('缓存清理成功', 'success');
            } catch (error) {
                showAlert('缓存清理失败: ' + error.message, 'error');
            }
        }

        // 查看分析数据
        async function viewAnalytics() {
            try {
                const response = await apiCall('/api/admin/analytics');
                // 这里可以显示详细的分析数据
                showAlert('分析数据加载完成', 'info');
            } catch (error) {
                showAlert('加载分析数据失败: ' + error.message, 'error');
            }
        }

        // 查看游戏统计
        async function viewGameStats() {
            try {
                const response = await apiCall('/api/admin/games/stats');
                // 这里可以显示游戏统计数据
                showAlert('游戏统计加载完成', 'info');
            } catch (error) {
                showAlert('加载游戏统计失败: ' + error.message, 'error');
            }
        }

        // 生成报告
        async function generateReport() {
            try {
                const response = await apiCall('/api/admin/reports/generate', 'POST');
                showAlert('报告生成中，请稍候...', 'info');
            } catch (error) {
                showAlert('生成报告失败: ' + error.message, 'error');
            }
        }

        // 系统健康检查
        async function checkSystemHealth() {
            try {
                const response = await apiCall('/api/admin/system/health');
                const status = response.status === 'healthy' ? 'success' : 'warning';
                showAlert(`系统状态: ${response.message}`, status);
            } catch (error) {
                showAlert('系统检查失败: ' + error.message, 'error');
            }
        }

        // 数据清理
        async function cleanupData() {
            const confirmed = await adminApp.confirm(
                '这将清理过期的验证码、临时文件等数据，确定继续吗？',
                '数据清理确认'
            );
            
            if (confirmed) {
                try {
                    await apiCall('/api/admin/system/cleanup', 'POST');
                    showAlert('数据清理完成', 'success');
                    loadDashboard(); // 重新加载数据
                } catch (error) {
                    showAlert('数据清理失败: ' + error.message, 'error');
                }
            }
        }

        // 重启服务
        async function restartServer() {
            const confirmed = await adminApp.confirm(
                '⚠️ 这将重启服务器，所有连接将断开，确定继续吗？',
                '重启服务器确认'
            );
            
            if (confirmed) {
                try {
                    await apiCall('/api/admin/system/restart', 'POST');
                    showAlert('服务器重启中...', 'warning');
                    
                    // 3秒后重新加载页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } catch (error) {
                    showAlert('重启失败: ' + error.message, 'error');
                }
            }
        }

        // 刷新日志
        async function refreshLogs() {
            try {
                const response = await apiCall('/api/admin/logs/recent');
                updateLogs(response.logs || []);
                showAlert('日志已刷新', 'success', 2000);
            } catch (error) {
                showAlert('刷新日志失败: ' + error.message, 'error');
            }
        }

        // 监听表单提交成功事件
        document.addEventListener('DOMContentLoaded', () => {
            // 加载仪表板数据
            loadDashboard();

            // 监听创建用户表单成功
            const createForm = document.querySelector('#createUserModal form');
            if (createForm) {
                createForm.addEventListener('success', () => {
                    closeModal('createUserModal');
                    createForm.reset();
                    loadDashboard(); // 重新加载数据
                });
            }

            // 定时刷新数据（每30秒）
            setInterval(loadDashboard, 30000);
        });
    </script>
</body>
</html> 