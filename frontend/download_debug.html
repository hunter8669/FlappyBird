<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹è½½è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #1a1a1a;
            color: #fff;
        }
        .debug-card {
            background: #2a2a2a;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5rem;
        }
        button:hover {
            background: #45a049;
        }
        #log {
            background: #000;
            color: #0f0;
            padding: 1rem;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¸‹è½½åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-card">
        <h3>æµ‹è¯•ä¸‹è½½æ–¹æ³•</h3>
        <button onclick="downloadMethod1()">æ–¹æ³•1: Fetch + Blob</button>
        <button onclick="downloadMethod2()">æ–¹æ³•2: ç›´æ¥é“¾æ¥</button>
        <button onclick="downloadMethod3()">æ–¹æ³•3: XMLHttpRequest</button>
        <button onclick="checkFileInfo()">æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="debug-card">
        <h3>ä¸‹è½½æ—¥å¿—</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // æ–¹æ³•1: ä½¿ç”¨Fetch API + Blob
        async function downloadMethod1() {
            try {
                log('å¼€å§‹æ–¹æ³•1ä¸‹è½½...');
                
                const response = await fetch('/api/downloads/desktop');
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                log(`Content-Type: ${response.headers.get('Content-Type')}`);
                log(`Content-Length: ${response.headers.get('Content-Length')}`);
                log(`Content-Disposition: ${response.headers.get('Content-Disposition')}`);
                
                if (!response.ok) {
                    const text = await response.text();
                    log(`é”™è¯¯å“åº”å†…å®¹: ${text}`);
                    return;
                }
                
                const blob = await response.blob();
                log(`Blobå¤§å°: ${blob.size} bytes (${(blob.size/1024/1024).toFixed(1)} MB)`);
                log(`Blobç±»å‹: ${blob.type}`);
                
                // æ£€æŸ¥æ–‡ä»¶å†…å®¹çš„å‰100å­—èŠ‚
                if (blob.size > 0) {
                    const firstBytes = await blob.slice(0, Math.min(blob.size, 100)).arrayBuffer();
                    const uint8Array = new Uint8Array(firstBytes);
                    const hexString = Array.from(uint8Array)
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join(' ');
                    log(`æ–‡ä»¶å¤´éƒ¨(hex): ${hexString}`);
                    
                    // å°è¯•è¯»å–ä¸ºæ–‡æœ¬ï¼ˆå¦‚æœæ˜¯é”™è¯¯ä¿¡æ¯ï¼‰
                    try {
                        const textContent = new TextDecoder().decode(firstBytes);
                        log(`æ–‡ä»¶å†…å®¹(æ–‡æœ¬): ${textContent}`);
                    } catch (e) {
                        log('æ–‡ä»¶å†…å®¹ä¸æ˜¯æ–‡æœ¬æ ¼å¼');
                    }
                    
                    // æ£€æŸ¥ZIPæ–‡ä»¶ç­¾å
                    if (uint8Array[0] === 0x50 && uint8Array[1] === 0x4B) {
                        log('âœ… æ£€æµ‹åˆ°æœ‰æ•ˆçš„ZIPæ–‡ä»¶ç­¾å');
                    } else {
                        log('âŒ æœªæ£€æµ‹åˆ°ZIPæ–‡ä»¶ç­¾å - è¿™å¯èƒ½æ˜¯é”™è¯¯ä¿¡æ¯è€Œä¸æ˜¯ZIPæ–‡ä»¶ï¼');
                        
                        // å¦‚æœæ–‡ä»¶å¾ˆå°ä¸”ä¸æ˜¯ZIPï¼Œå¾ˆå¯èƒ½æ˜¯JSONé”™è¯¯ä¿¡æ¯
                        if (blob.size < 1000) {
                            log('âš ï¸ æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨é”™è¯¯ä¿¡æ¯');
                            try {
                                const errorText = await blob.text();
                                log(`æœåŠ¡å™¨é”™è¯¯å†…å®¹: ${errorText}`);
                                return;
                            } catch (e) {
                                log('æ— æ³•è¯»å–é”™è¯¯å†…å®¹');
                            }
                        }
                    }
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'FlapPyBird-Debug-Method1.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                log('æ–¹æ³•1ä¸‹è½½å®Œæˆ');
            } catch (error) {
                log(`æ–¹æ³•1é”™è¯¯: ${error.message}`);
                console.error(error);
            }
        }

        // æ–¹æ³•2: ç›´æ¥é“¾æ¥ä¸‹è½½
        function downloadMethod2() {
            try {
                log('å¼€å§‹æ–¹æ³•2ä¸‹è½½...');
                
                const a = document.createElement('a');
                a.href = '/api/downloads/desktop';
                a.download = 'FlapPyBird-Debug-Method2.zip';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                log('æ–¹æ³•2ä¸‹è½½å·²è§¦å‘');
            } catch (error) {
                log(`æ–¹æ³•2é”™è¯¯: ${error.message}`);
            }
        }

        // æ–¹æ³•3: XMLHttpRequest
        function downloadMethod3() {
            try {
                log('å¼€å§‹æ–¹æ³•3ä¸‹è½½...');
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/downloads/desktop', true);
                xhr.responseType = 'blob';
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        log(`XHRçŠ¶æ€: ${xhr.status}`);
                        log(`å“åº”ç±»å‹: ${xhr.response.type}`);
                        log(`å“åº”å¤§å°: ${xhr.response.size} bytes`);
                        
                        const blob = xhr.response;
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'FlapPyBird-Debug-Method3.zip';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        log('æ–¹æ³•3ä¸‹è½½å®Œæˆ');
                    } else {
                        log(`XHRé”™è¯¯: ${xhr.status} ${xhr.statusText}`);
                    }
                };
                
                xhr.onerror = function() {
                    log('XHRç½‘ç»œé”™è¯¯');
                };
                
                xhr.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percent = ((e.loaded / e.total) * 100).toFixed(1);
                        log(`ä¸‹è½½è¿›åº¦: ${percent}% (${e.loaded}/${e.total})`);
                    }
                };
                
                xhr.send();
            } catch (error) {
                log(`æ–¹æ³•3é”™è¯¯: ${error.message}`);
            }
        }

        // æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯
        async function checkFileInfo() {
            try {
                log('æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯...');
                
                const response = await fetch('/api/downloads/desktop', {
                    method: 'HEAD'
                });
                
                if (response.status === 501) {
                    log('æœåŠ¡å™¨ä¸æ”¯æŒHEADè¯·æ±‚ï¼Œå°è¯•GETè¯·æ±‚...');
                    
                    const getResponse = await fetch('/api/downloads/desktop');
                    log(`GETå“åº”çŠ¶æ€: ${getResponse.status}`);
                    log(`Content-Type: ${getResponse.headers.get('Content-Type')}`);
                    log(`Content-Length: ${getResponse.headers.get('Content-Length')}`);
                    log(`Content-Disposition: ${getResponse.headers.get('Content-Disposition')}`);
                    
                    // è¯»å–å‰100å­—èŠ‚æ£€æŸ¥æ–‡ä»¶æ ¼å¼
                    const blob = await getResponse.blob();
                    const firstBytes = await blob.slice(0, 100).arrayBuffer();
                    const uint8Array = new Uint8Array(firstBytes);
                    const hexString = Array.from(uint8Array)
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join(' ');
                    log(`æ–‡ä»¶å¤´éƒ¨(hex): ${hexString}`);
                    
                    // æ£€æŸ¥ZIPæ–‡ä»¶ç­¾å
                    if (uint8Array[0] === 0x50 && uint8Array[1] === 0x4B) {
                        log('âœ… æ£€æµ‹åˆ°æœ‰æ•ˆçš„ZIPæ–‡ä»¶ç­¾å');
                    } else {
                        log('âŒ æœªæ£€æµ‹åˆ°ZIPæ–‡ä»¶ç­¾å');
                    }
                    
                } else {
                    log(`HEADå“åº”çŠ¶æ€: ${response.status}`);
                    for (const [key, value] of response.headers.entries()) {
                        log(`${key}: ${value}`);
                    }
                }
            } catch (error) {
                log(`æ£€æŸ¥é”™è¯¯: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            log('ä¸‹è½½è°ƒè¯•å·¥å…·å·²åŠ è½½');
            log('è¯·é€‰æ‹©ä¸€ç§ä¸‹è½½æ–¹æ³•è¿›è¡Œæµ‹è¯•');
        });
    </script>
</body>
</html> 